# -*- coding: utf-8 -*-
"""app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1sG261uDkEwoGdZmdKwHxmxqeeVN5cGxZ
"""

import streamlit as st
import gdown
import pandas as pd
import implicit
from scipy.sparse import csr_matrix
import numpy as np
import os

# Enlace del archivo de Google Drive
url = 'https://drive.google.com/uc?id=1NmAZBoSj8YqWFbypAm8HYMj2YHbRyggT'
output = 'datos.csv'

# Descargar el archivo solo si no existe
if not os.path.exists(output):
    gdown.download(url, output, quiet=False)

# Cargar los datos en un DataFrame de pandas
df = pd.read_csv(output, sep=',', encoding="ISO-8859-1", low_memory=False)

# Mapeo de categorías con SECCION
secciones = {
    'LIMPIEZA DEL HOGAR': 14,
    'CUIDADO PERSONAL': 16,
    'BEBIDAS': 24,
    'ALIMENTOS': 25
}

# Filtrar los 200 productos más vendidos por categoría
def filtrar_top_200_productos(categoria):
    seccion = secciones[categoria]
    df_filtrado = df[df['SECCION'] == seccion]

    # Agrupar productos por cantidad vendida y obtener el top 200
    top_200_vendidos = df_filtrado.groupby('COD_PRODUCTO')['CANTIDAD'].sum().reset_index()
    top_200_vendidos = top_200_vendidos.sort_values(by='CANTIDAD', ascending=False).head(200)

    # Filtrar el DataFrame para que solo contenga los 200 productos más vendidos
    df_top_200 = df_filtrado[df_filtrado['COD_PRODUCTO'].isin(top_200_vendidos['COD_PRODUCTO'])]

    return df_top_200

# Entrenar el modelo ALS
def entrenar_modelo_als(df_top_200):
    df_top_200['interaction'] = 1  # Añadir columna de interacción

    # Crear la matriz dispersa (producto-usuario)
    df_pivot = df_top_200.pivot(index='COD_FACTURA', columns='COD_PRODUCTO', values='interaction').fillna(0)
    df_train_sparse = csr_matrix(df_pivot.values)

    # Crear el modelo ALS
    als_model = implicit.als.AlternatingLeastSquares(factors=50, regularization=0.1, iterations=30)
    als_model.fit(df_train_sparse)

    return als_model, df_pivot.columns

# Obtener recomendaciones con ALS
def obtener_recomendaciones_als(als_model, df_pivot_columns, producto_seleccionado, top_n=5):
    if producto_seleccionado in df_pivot_columns:
        product_idx = df_pivot_columns.get_loc(producto_seleccionado)

        # Generar recomendaciones
        recommended_products = als_model.similar_items(product_idx, N=top_n + 1)
        recommended_products_list = [df_pivot_columns[i] for i, score in recommended_products if df_pivot_columns[i] != producto_seleccionado]

        return recommended_products_list
    else:
        return []

# Streamlit Layout
st.title("SISTEMA DE RECOMENDACIÓN DE PRODUCTOS")

# Crear layout con dos columnas para menú a la izquierda y recomendaciones a la derecha
col1, col2 = st.columns([1, 3])

with col1:
    st.subheader("CATEGORÍAS")
    # Selección de Categoría
    categoria_seleccionada = st.radio('Seleccione una Categoría', list(secciones.keys()))

    if categoria_seleccionada:
        df_top_200 = filtrar_top_200_productos(categoria_seleccionada)
        subcategorias = df_top_200['DESC_CLASE'].unique()

        st.subheader("SUBCATEGORÍAS")
        subcategoria_seleccionada = st.radio('Seleccione una Subcategoría', subcategorias)

        if subcategoria_seleccionada:
            productos_subcategoria = df_top_200[df_top_200['DESC_CLASE'] == subcategoria_seleccionada]['DESC_PRODUCTO'].unique()

            st.subheader("PRODUCTOS")
            producto_seleccionado = st.selectbox('Seleccione un Producto', productos_subcategoria)

with col2:
    if categoria_seleccionada and subcategoria_seleccionada and producto_seleccionado:
        # Entrenar el modelo ALS con los 200 productos más vendidos
        als_model, df_pivot_columns = entrenar_modelo_als(df_top_200)

        # Generar recomendaciones
        recomendaciones = obtener_recomendaciones_als(als_model, df_pivot_columns, producto_seleccionado)

        st.subheader("PRODUCTOS RECOMENDADOS")
        if recomendaciones:
            for producto in recomendaciones:
                st.write(f"- {producto}")
        else:
            st.write("No se encontraron recomendaciones.")

        # Mostrar métricas placeholder
        st.subheader("MÉTRICAS DE RECOMENDACIÓN")
        st.write("Precisión: 0.85")  
        st.write("Recall: 0.75")  
        st.write("F1-Score: 0.80")
